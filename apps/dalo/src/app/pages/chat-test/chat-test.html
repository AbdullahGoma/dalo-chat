<div
  class="h-screen flex flex-col bg-background px-10"
  [class.dark]="isDarkTheme()"
>
  <!-- Header -->
  <header
    class="h-9 bg-background rounded-3 border border-border shadow-sm flex items-center justify-between p-7 my-2 sticky top-0 z-50"
  >
    <!-- Left: Dalo Chat -->
    <h1 class="text-base font-bold text-foreground font-logo">Dalo Chat</h1>

    <!-- Right: Icons -->
    <div class="flex items-center gap-3">
      <!-- Theme Toggle -->
      <button
        (click)="toggleTheme()"
        class="w-8 h-8 rounded-full bg-surface hover:bg-surface/50 flex items-center justify-center transition-colors duration-200 focus:outline-none focus:ring-1 focus:ring-foreground"
        title="Toggle theme"
      >
        @if (isDarkTheme()) {
        <svg
          class="w-8 h-8 scale-150 text-foreground"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="3"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
        } @else {
        <svg
          class="w-4 h-4 scale-125 text-foreground"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="3"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          />
        </svg>
        }
      </button>

      <!-- Add Chat -->
      <button
        (click)="createChat()"
        class="w-8 h-8 rounded-full bg-accent hover:bg-accent text-background flex items-center justify-center transition-colors duration-200 focus:outline-none focus:ring-1 focus:ring-accent disabled:opacity-50 disabled:cursor-not-allowed"
        [disabled]="chats().length >= 5"
        title="New chat"
      >
        <svg
          class="w-8 h-8 scale-150 text-background"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          />
        </svg>
      </button>

      <!-- All Chats Dropdown -->
      <div class="relative">
        <div
          class="w-8 h-8 rounded-full bg-surface hover:bg-surface/50 flex items-center justify-center transition-colors duration-200 cursor-pointer"
          [libHoverDropdown]="chatDropdownTpl"
          title="All chats"
        >
          <svg
            class="w-6 h-6 text-foreground"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
            />
          </svg>
        </div>

        <ng-template #chatDropdownTpl>
          <div
            class="absolute top-full right-1 mt-3 w-max bg-background rounded-3 shadow-xl border border-border overflow-hidden"
          >
            @if (chats().length > 0) {
            <div class="px-2 py-1 border-b border-border">
              <h3 class="font-bold text-foreground text-base">All Chats</h3>
            </div>
            <div>
              @for (chat of chats(); track chat.id) {
              <div
                class="flex items-center gap-2 px-2 py-1 hover:bg-hover cursor-pointer border-b border-border last:border-b-0"
                [class.bg-hover]="selectedChatId() === chat.id"
                (click)="selectChat(chat.id)"
                tabindex="0"
                role="button"
                (keydown.enter)="selectChat(chat.id)"
                (keydown.space)="selectChat(chat.id)"
              >
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-foreground truncate">
                    {{ chat.title }}
                  </p>
                  <p class="text-nano text-muted">
                    {{ chat.updatedAt | date: 'short' }}
                  </p>
                </div>
                @if (selectedChatId() === chat.id) {
                <div class="w-2 h-2 rounded-full bg-hover"></div>
                }

                <!-- Delete button -->
                <button
                  class="border-none bg-transparent p-1 rounded-full hover:bg-destructive/20 transition-colors duration-200 flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-red-500 cursor-pointer"
                  (click)="deleteChat(chat.id, $event)"
                  title="Delete chat"
                  type="button"
                >
                  <svg
                    class="w-6 h-6 text-destructive fill-current"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 640 640"
                  >
                    <path
                      d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"
                    />
                  </svg>
                </button>
              </div>
              }
            </div>
            } @else {
            <div class="p-4 text-center text-muted">
              <p>No chats yet</p>
            </div>
            }
          </div>
        </ng-template>
      </div>
    </div>
  </header>

  <!-- Main Chat Area -->
  <main
    class="flex-1 flex flex-col min-h-0 px-2 overflow-y-auto scrollbar-hidden"
  >
    @if (selectedChatId()) {
    <div class="flex-1 flex flex-col min-h-0 bg-background rounded-3 shadow-sm">
      <!-- Messages Area -->
      <div class="flex-1 flex flex-col min-h-0 rounded-t-3">
        <!-- Load More Messages Trigger at Top -->
        @defer (on viewport; prefetch on idle) { @if (hasMoreMessages()) {
        <div #loadMoreTrigger class="w-full py-2 px-4 text-center">
          @if (loading()) {
          <div class="flex items-center justify-center gap-2 py-4">
            <div
              class="animate-spin rounded-full h-4 w-4 border-2 border-b-transparent border-accent"
            ></div>
            <span class="text-muted">Loading messages...</span>
          </div>
          } @else {
          <div class="py-2 text-muted text-sm">
            Scroll up to load more messages
          </div>
          }
        </div>
        } } @placeholder {
        <div class="w-full py-2 px-4 text-center">
          <div class="py-2 text-muted text-sm">
            <!-- Placeholder content while waiting for viewport trigger -->
          </div>
        </div>
        } @loading {
        <div class="w-full py-4 px-4 text-center">
          <div class="flex items-center justify-center gap-2">
            <div
              class="animate-spin rounded-full h-4 w-4 border-2 border-b-transparent border-border"
            ></div>
            <span class="text-muted">Loading messages...</span>
          </div>
        </div>
        }

        <div class="flex-1 p-4 space-y-4">
          @for (msg of messages(); track $index) {
          <div>
            @if (msg.role === 'USER') {
            <div class="flex justify-end">
              <div class="flex gap-3 max-w-4xl">
                <div
                  class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 bg-foreground text-background"
                >
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                    />
                  </svg>
                </div>
                <div class="flex-1">
                  <div class="p-3 rounded-3 bg-foreground text-background">
                    {{ msg.content }}
                  </div>
                  <div class="text-xs text-muted mt-1">
                    {{ msg.createdAt | date: 'short' }}
                  </div>
                </div>
              </div>
            </div>
            } @else {
            <div class="flex justify-start">
              <div class="flex gap-3 max-w-4xl">
                <div
                  class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 bg-foreground text-background"
                >
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                    />
                  </svg>
                </div>
                <div class="flex-1">
                  <div
                    class="p-3 rounded-3 bg-background text-foreground border border-border"
                    [innerHTML]="msg.content | formatMessage"
                  ></div>
                  <div class="text-xs text-muted mt-1">
                    {{ msg.createdAt | date: 'short' }}
                  </div>
                </div>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
    } @else {
    <div
      class="flex-1 flex items-center justify-center bg-background rounded-3 shadow-sm mx-2"
    >
      <div class="text-center">
        <h2 class="text-2xl font-bold text-foreground mb-4">
          Welcome to Dalo Chat
        </h2>
        <p class="text-muted text-sm">
          Click on the chat icon in the header to select or create a chat.
        </p>
      </div>
    </div>
    }
  </main>

  @if(selectedChatId()) {
  <!-- Input Area -->
  <footer
    class="bg-background p-4 rounded-b-3 sticky bottom-2 left-1 right-1 px-10"
  >
    <div class="flex items-center relative">
      <textarea
        [(ngModel)]="message"
        placeholder="Type your message..."
        class="flex-1 p-3 pr-10 border border-border rounded-3 resize-none focus:outline-none focus:ring-1 focus:ring-muted focus:border-transparent min-h-8 max-h-32 cursor-pointer disabled:bg-surface disabled:cursor-not-allowed scrollbar-hidden"
        rows="1"
        (keydown)="onKeyDown($event)"
        [disabled]="isSending()"
      ></textarea>
      <button
        (click)="sendMessage()"
        class="absolute right-2 w-8 h-8 bg-muted text-background rounded-full hover:bg-hover transition-colors duration-200 focus:outline-none focus:ring-1 focus:ring-muted flex items-center justify-center cursor-pointer disabled:bg-muted/50 disabled:cursor-not-allowed"
        [disabled]="!message.trim() || isSending()"
      >
        @if (isSending()) {
        <div
          class="animate-spin rounded-full h-4 w-4 border-2 border-border border-b-transparent"
        ></div>
        } @else {
        <svg
          class="w-4 h-4 text-foreground"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
          />
        </svg>
        }
      </button>
    </div>
  </footer>
  }
</div>
